name: ci

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    services:
      redpanda:
        image: redpandadata/redpanda:v24.2.9
        ports:
          - 9092:9092
        options: >-
          --health-cmd "rpk cluster health | grep -q 'Healthy: true'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        command: >-
          redpanda start --overprovisioned --smp 1 --memory 1G --reserve-memory 0M
          --node-id 0 --check=false --kafka-addr PLAINTEXT://0.0.0.0:9092
          --advertise-kafka-addr PLAINTEXT://127.0.0.1:9092

    env:
      KAFKA_BROKERS: 127.0.0.1:9092

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - run: pip install -e .[dev,kafka]
      - run: ruff check .
      - run: mypy src
      - run: pytest
